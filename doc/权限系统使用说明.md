# 权限系统使用说明

## 📋 概述

系统实现了基于角色的权限管理（RBAC），支持细粒度的权限控制。不同权限的用户登录后会看到不同的仪表板和功能。

---

## 🔐 权限定义

系统包含以下权限：

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| `VIEW_INVENTORY` | 查看堆场库存 | 可以查看堆场库存信息 |
| `VIEW_VESSEL` | 查看船舶访问信息 | 可以查看船舶访问记录 |
| `VIEW_TASK` | 查看任务信息 | 可以查看作业任务 |
| `VIEW_STATISTICS` | 查看统计报表 | 可以查看统计报表 |
| `CREATE_TASK` | 创建作业任务 | 可以创建新的作业任务 |
| `UPDATE_TASK` | 更新任务状态 | 可以更新任务状态 |
| `DELETE_TASK` | 删除任务 | 可以删除任务 |
| `MANAGE_BOOKING` | 管理订舱单 | 可以管理订舱单 |
| `MANAGE_CONTAINER` | 管理集装箱 | 可以管理集装箱信息 |
| `MANAGE_VESSEL` | 管理船舶信息 | 可以管理船舶信息 |
| `MANAGE_YARD` | 管理堆场信息 | 可以管理堆场信息 |
| `MANAGE_USER` | 管理用户 | 可以管理用户账号 |
| `MANAGE_PERMISSION` | 管理权限 | 可以管理权限分配 |
| `ADMIN` | 系统管理员 | 拥有所有权限 |

---

## 👥 用户角色

系统根据用户权限自动识别角色：

### 1. 管理员（Admin）
- **权限要求**：拥有 `ADMIN` 或 `MANAGE_ALL` 权限
- **功能**：
  - 访问所有功能模块
  - 管理用户和权限
  - 查看所有统计数据
  - 执行所有操作

### 2. 操作员（Operator）
- **权限要求**：拥有 `CREATE_TASK` 或 `UPDATE_TASK` 权限
- **功能**：
  - 查看堆场库存
  - 查看船舶访问信息
  - 创建和管理任务
  - 查看自己的任务统计

### 3. 查看者（Viewer）
- **权限要求**：拥有 `VIEW_INVENTORY` 或 `VIEW_STATISTICS` 权限
- **功能**：
  - 查看堆场库存（只读）
  - 查看船舶访问信息（只读）
  - 查看统计报表（只读）
  - 无法进行任何修改操作

### 4. 访客（Guest）
- **权限要求**：无任何权限
- **功能**：
  - 仅显示欢迎信息
  - 无法访问任何功能模块

---

## 🚀 初始化权限

### 1. 执行权限初始化脚本

```bash
mysql -u root -p box_management < init_permissions.sql
```

### 2. 为用户分配权限

#### 方法一：通过SQL直接分配

```sql
-- 为用户ID为1的用户分配管理员权限
INSERT INTO User_Permissions (User_ID, Permission_ID)
SELECT 1, Permission_ID FROM Permissions WHERE Permission_Name = 'ADMIN';

-- 为用户ID为2的用户分配操作员权限
INSERT INTO User_Permissions (User_ID, Permission_ID)
SELECT 2, Permission_ID FROM Permissions 
WHERE Permission_Name IN ('VIEW_INVENTORY', 'VIEW_VESSEL', 'VIEW_TASK', 'CREATE_TASK', 'UPDATE_TASK');

-- 为用户ID为3的用户分配查看者权限
INSERT INTO User_Permissions (User_ID, Permission_ID)
SELECT 3, Permission_ID FROM Permissions 
WHERE Permission_Name IN ('VIEW_INVENTORY', 'VIEW_VESSEL', 'VIEW_TASK', 'VIEW_STATISTICS');
```

#### 方法二：通过Django Admin分配

1. 登录系统（使用管理员账号）
2. 进入"用户管理"页面
3. 选择要分配权限的用户
4. 在"用户权限"部分添加相应权限

---

## 🔧 权限检查机制

### 1. 装饰器方式

在视图函数上使用 `@require_permission` 装饰器：

```python
from management.utils import require_permission

@require_permission('VIEW_INVENTORY')
def yard_inventory_view(request):
    # 只有拥有 VIEW_INVENTORY 权限的用户才能访问
    ...
```

### 2. 手动检查

在视图函数中手动检查权限：

```python
from management.utils import has_permission

def my_view(request):
    user_id = request.session.get('user_id')
    if not has_permission(user_id, 'VIEW_INVENTORY'):
        messages.error(request, '您没有权限访问此页面')
        return redirect('dashboard')
    # 继续处理请求
    ...
```

---

## 📱 登录流程

1. **访问系统**：用户访问系统根路径，自动重定向到 `/login/`
2. **输入凭据**：用户输入用户名和密码
3. **身份验证**：系统验证用户凭据（使用Django认证系统）
4. **权限加载**：系统从数据库加载用户权限并存入session
5. **角色识别**：系统根据权限自动识别用户角色
6. **跳转仪表板**：根据角色跳转到对应的仪表板页面

---

## 🎨 不同角色的仪表板

### 管理员仪表板 (`dashboard_admin.html`)
- 显示所有统计信息
- 提供所有功能入口
- 包含用户管理和权限管理入口

### 操作员仪表板 (`dashboard_operator.html`)
- 显示我的待执行任务
- 显示已完成任务统计
- 提供任务管理和库存查看入口

### 查看者仪表板 (`dashboard_viewer.html`)
- 显示只读统计信息
- 提供查看功能入口
- 明确标注"只读模式"

### 访客仪表板 (`dashboard_guest.html`)
- 显示欢迎信息
- 提示联系管理员获取权限

---

## 🔒 权限保护的功能页面

以下功能页面已添加权限保护：

| 页面 | URL | 所需权限 |
|------|-----|---------|
| 堆场库存 | `/admin/yard-inventory/` | `VIEW_INVENTORY` |
| 船舶访问 | `/admin/vessel-visit/` | `VIEW_VESSEL` |
| 任务管理 | `/admin/task-management/` | `VIEW_TASK` |
| 统计报表 | `/admin/statistics/` | `VIEW_STATISTICS` |

---

## 📝 使用示例

### 创建管理员用户

```sql
-- 1. 创建Django超级用户（用于登录认证）
-- 在命令行执行：
-- python manage.py createsuperuser

-- 2. 在数据库中创建对应的Users记录
INSERT INTO Users (Username, Hashed_Password, Full_Name, Email, Is_Active)
VALUES ('admin', '...', '系统管理员', 'admin@example.com', 1);

-- 3. 分配管理员权限
INSERT INTO User_Permissions (User_ID, Permission_ID)
SELECT LAST_INSERT_ID(), Permission_ID FROM Permissions WHERE Permission_Name = 'ADMIN';
```

### 创建操作员用户

```sql
-- 1. 创建用户
INSERT INTO Users (Username, Hashed_Password, Full_Name, Email, Is_Active)
VALUES ('operator1', '...', '操作员1', 'operator1@example.com', 1);

-- 2. 分配操作员权限
INSERT INTO User_Permissions (User_ID, Permission_ID)
SELECT LAST_INSERT_ID(), Permission_ID FROM Permissions 
WHERE Permission_Name IN (
    'VIEW_INVENTORY', 
    'VIEW_VESSEL', 
    'VIEW_TASK', 
    'CREATE_TASK', 
    'UPDATE_TASK'
);
```

---

## ⚠️ 注意事项

1. **Django用户与数据库用户**：系统使用Django的认证系统进行登录验证，但权限信息存储在自定义的`Users`表中。需要确保Django用户和数据库用户一一对应。

2. **权限缓存**：用户权限信息存储在session中，修改权限后需要用户重新登录才能生效。

3. **默认权限**：新创建的用户默认没有任何权限，需要手动分配。

4. **权限继承**：拥有`ADMIN`权限的用户自动拥有所有权限。

---

## 🐛 故障排查

### 问题1：登录后显示"访客"角色

**原因**：用户没有分配任何权限

**解决**：为用户分配相应权限

```sql
-- 查看用户权限
SELECT * FROM View_User_Permissions WHERE 用户名 = 'your_username';

-- 分配权限
INSERT INTO User_Permissions (User_ID, Permission_ID)
SELECT User_ID, Permission_ID FROM Users u, Permissions p
WHERE u.Username = 'your_username' 
AND p.Permission_Name = 'VIEW_INVENTORY';
```

### 问题2：无法访问功能页面

**原因**：用户没有相应的权限

**解决**：检查用户权限并分配所需权限

```sql
-- 检查用户权限
SELECT p.Permission_Name, p.Description
FROM User_Permissions up
JOIN Permissions p ON up.Permission_ID = p.Permission_ID
JOIN Users u ON up.User_ID = u.User_ID
WHERE u.Username = 'your_username';
```

### 问题3：权限修改后不生效

**原因**：权限信息缓存在session中

**解决**：用户需要重新登录

---

## 📚 相关文件

- `management/utils.py` - 权限检查工具函数
- `management/auth_views.py` - 认证和仪表板视图
- `management/admin.py` - 功能页面视图（已添加权限检查）
- `init_permissions.sql` - 权限初始化脚本
- `management/templates/management/dashboard_*.html` - 各角色仪表板模板

---

**最后更新**：2024年






