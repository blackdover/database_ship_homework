# 系统设计与实现

本章节为课程设计报告中“系统设计与实现”部分，基于代码仓库中的实现进行归纳与说明。文中以学术、正式中文撰写，并在必要处引用项目内文件路径以便核对实现细节。

---

## 1 项目文件结构（程序项目结构）

项目采用 Django 框架组织，主要文件与目录（摘取主要项）如下：

- `manage.py`
- `container_management/`
  - `container_management/`
    - `__init__.py`
    - `settings.py` （项目配置，包含数据库连接等）
    - `urls.py` （全局路由映射）
    - `wsgi.py` / `asgi.py`
  - `manage.py` （Django 项目管理命令）
  - `create_superuser.py`
  - `insert_sample_data.py`
  - `reset_password.py`
  - `sync_user.py`
  - `management/` （Django 应用：实现业务逻辑）
    - `admin.py`
    - `apps.py`
    - `auth_views.py` （自定义登录/登出与仪表盘视图）
    - `dashboard_views.py` （仪表盘展示视图）
    - `dashboard_context.py` （模板上下文处理：仪表盘统计）
    - `views.py` （通用业务视图，如聚合搜索）
    - `utils.py` （工具/权限检查、数据库辅助函数）
    - `models.py` （ORM 实体定义，映射到数据库表）
    - `migrations/` （数据库迁移历史）
    - `templates/` / `static/` （前端页面与静态资源）
- `sqlutil/`
  - `createtable.sql` （数据库建表脚本）
  - `init_database.sql` 等 （初始化、触发器、视图等）
- `doc/` （项目文档、说明与使用指南）
- `bat/` （批处理脚本：初始化、同步、重置密码等）
- `staticfiles/` （静态文件集合，供部署时收集）

各主要文件夹角色说明：

- `container_management/`（项目根与配置）：包含 Django 项目的全局配置（`settings.py`）、全局路由（`urls.py`）与 WSGI/ASGI 入口；负责项目级别的中间件、安全、模板目录与静态文件配置等。
- `management/`（核心应用）：实现系统的业务模型（`models.py`）、视图（`views.py`、`dashboard_views.py`、`auth_views.py`）、管理模板与静态资源。该模块承担业务对象建模、权限校验逻辑、页面渲染与与数据库交互的上层封装，是系统的核心。
- `sqlutil/`（数据库脚本）：以原生 SQL 脚本提供建表、视图、触发器及初始样本数据，作为数据库结构与数据初始化依据。
- `doc/`（项目文档）：记录系统设计说明、启动步骤、权限说明、答辩要点等，便于课程设计提交与审阅。
- `staticfiles/` 与 `management/templates/`：存放前端静态资源与模板，配合 Django 模板系统输出管理后台与自定义页面；`simpleui` 用于美化与集成仪表盘功能。
- 批处理脚本（`bat/`）：便捷的管理脚本，用于数据初始化、用户同步与权限初始化，适合教学演示或部署辅助。

---

## 2 核心功能模块实现（功能模块介绍）

本系统的核心逻辑集中于三大类模块：数据模型层（实体建模）、权限工具模块（数据库视图与原生 SQL 调用）、以及业务视图（含复杂查询与性能优化）。下文分别描述其职责、主要属性与关键方法，并给出关键实现片段与原理说明。

### 2.1 数据模型模块 — `management/models.py`

职责：通过 Django ORM 定义系统的业务实体并映射到数据库表，负责字段类型、唯一性/外键约束、模型级校验与字符串表示等，并在部分模型中实现跨字段校验以保证业务层数据一致性。

代表实体（示例）：

- `ContainerMaster`（集装箱主数据）

  - 属性：`container_master_id`（主键）、`container_number`（唯一）、`type_code`（外键，指向 `ContainerTypeDict`）、`current_status`
  - 说明：作为库存、任务与箱位关联的核心实体，模型通过 `Meta.db_table = 'Container_Master'` 与 SQL 脚本保持一致。

- `VesselVisit`（船舶挂靠记录）

  - 属性：`vessel_visit_id`、`vessel_id`、`port_id`、`berth_id`、`voyage_number_in`、`ata`、`atd`、`status`
  - 关键方法：实现 `clean()`（跨字段一致性校验）并在 `save()` 中调用 `full_clean()`，以保证程序化保存同样执行校验。

- `Task`（作业任务）
  - 属性：`task_id`、`task_type`、`status`、`container_master_id`、`from_slot_id`、`to_slot_id`、`created_by_user_id` 等
  - 说明：作为事务类表，关联箱位、集装箱与用户，用于计划与执行流程的状态流转。

（完整模型定义见：`container_management/management/models.py`）

### 2.2 权限工具模块 — `management/utils.py`

职责：提供权限集合读取、权限检查装饰器与角色判断逻辑。为提高查询效率，优先使用数据库视图读取权限聚合结果；在视图缺失或异常时回退到 ORM 查询。

主要函数：

- `get_user_permission_names(user_id)`：优先通过参数化 SQL 从数据库视图 `View_User_Permissions` 读取逗号分隔的权限字符串并拆分；若失败则使用 ORM 查询 `UserPermissions` 表。
- `require_permission(permission_name)`：用于视图的装饰器，封装登录检查、Django 用户与自定义 `Users` 表的映射以及权限验证，失败时通过消息提示并重定向。

设计考量：该模块在性能（视图 + 原生 SQL）与兼容性（视图缺失回退 ORM）之间取得平衡。见实现：`container_management/management/utils.py`。

### 2.3 业务聚合搜索视图 — `management/views.py`

职责：提供单一输入框的聚合检索，支持并行查询多个核心模型（集装箱、订舱单、任务、船舶访问、相关方），并返回各类结果供快捷跳转或操作。

实现要点：

- 使用 `select_related()` 预加载外键以避免 N+1 查询；
- 使用 `Q` 对象组合多字段模糊匹配（`__icontains`）；
- 对每类结果使用 `order_by` 与切片限制返回条数（例如 10 条）以控制响应体积。

（示例实现见：`container_management/management/views.py`）

---

## 3 数据库访问层设计（数据库设计与实现）

### 3.1 连接方式与技术栈

系统采用 Django ORM 作为主要的数据访问层，数据库后端为 MySQL。数据库连接配置位于 `container_management/container_management/settings.py` 的 `DATABASES` 配置中，采用 `django.db.backends.mysql` 驱动，由 Django 管理连接池与事务。

设计基点：

- 优先使用 ORM 保持代码可维护性；在性能敏感或需利用数据库特性（视图、触发器、复杂 CHECK）时使用参数化原生 SQL（`connection.cursor()`）；
- 将原生 SQL 建表与视图定义保存在 `sqlutil/` 中，以便环境初始化与审计。

### 3.2 关键模型—表对应关系（示例）

- `Users` → `Users`（用户信息）
- `Party` → `Party`（相关方）
- `ContainerMaster` → `Container_Master`（集装箱主数据）
- `ContainerTypeDict` → `Container_Type_Dict`（箱型字典）
- `YardBlock` → `Yard_Block`（堆场区）
- `YardStack` → `Yard_Stack`（堆栈）
- `YardSlot` → `Yard_Slot`（箱位）
- `VesselVisit` → `Vessel_Visit`（船舶访问）
- `Booking` → `Booking`（订舱单）
- `Task` → `Task`（作业任务）
- `Permissions` / `UserPermissions` → `Permissions` / `User_Permissions`（用户权限关联表，数据库层为复合主键）

说明：多数模型在 `Meta.db_table` 中显式指定表名并通过 `db_column` 指定列名以与 `sqlutil/createtable.sql` 中的表结构保持一致，从而支持 ORM 与原生 SQL 脚本并存的维护流程。

### 3.3 事务管理与原生 SQL 使用

- 事务管理：建议在跨表写入或状态变更（如任务分配同时变更箱位）时使用 Django 的事务上下文（`transaction.atomic()`）以保证原子性。
- 原生 SQL 场景：读取数据库视图（权限聚合）、执行建表/视图/触发器脚本、对复合主键表做批量操作等。原生 SQL 使用参数化查询以防注入并在出错时回退到 ORM 路径以保持鲁棒性。

### 3.4 模型与约束说明

- 复合主键问题：`User_Permissions` 使用复合主键（`User_ID`, `Permission_ID`），Django ORM 不原生支持复合主键，因此对该表的某些操作需使用原生 SQL。
- 索引与约束：建表脚本中包含了大量唯一索引、外键约束与 CHECK 约束，且为若干字段添加了复合唯一索引以保证数据完整性与查询性能（详见 `sqlutil/createtable.sql`）。

### 3.5 数据迁移与初始化策略

- 常规开发使用 Django migration 管理模式演进；项目同时提供 `sqlutil/` 中的原生 SQL 以便在教学或恢复场景直接执行建表与初始化。
- 在生产部署建议以 migration 为主，并将视图/触发器脚本纳入可重复执行的部署步骤以保证结构一致。

---

## 4 接口设计文档（附录）

项目以 Web 页面为主，采用 Django 视图方式提供后端功能。以下列出 5 个核心接口（视图路由），按报告要求格式给出：

1.

- **接口描述**：自定义登录页面（替代 Django 默认登录）
- **请求方法/路径**：GET / POST `/login/`
- **请求参数**：POST: `username`、`password`；可选 `next`（跳转目标）
- **返回数据**：HTML 页面（登录表单）；成功后重定向至 `/admin/` 或 `next`。

2.

- **接口描述**：用户仪表盘（普通用户）
- **请求方法/路径**：GET `/dashboard/`
- **请求参数**：无（需已登录会话）
- **返回数据**：HTML 页面（仪表盘），上下文包含统计数据与用户角色信息。

3.

- **接口描述**：管理仪表盘（simpleui 内嵌管理员仪表盘）
- **请求方法/路径**：GET `/admin/dashboard/`
- **请求参数**：无（需管理员权限）
- **返回数据**：HTML 页面（管理仪表盘）。

4.

- **接口描述**：聚合搜索（多模型并行检索）
- **请求方法/路径**：GET `/admin/search/?q={query}`
- **请求参数**：`q`（搜索关键词）
- **返回数据**：HTML 页面 `management/aggregate_search.html`，上下文返回若干实体结果集（容器、订舱单、任务、船舶访问、相关方），每类结果限制为最多 10 条。

5.

- **接口描述**：Django Admin 管理界面（模型 CRUD）
- **请求方法/路径**：GET/POST `/admin/` 及其子路径（例如 `/admin/management/containermaster/<id>/change/`）
- **请求参数**：依具体模型表单而定（标准 Django Admin 表单字段）
- **返回数据**：HTML 页面（管理表单）、提交后重定向或返回表单校验错误。

---

## 附：关键实现片段与设计要点（引用）

以下为项目中用于保证数据一致性与提高权限查询效率的代表性代码位置，供审阅时核对：

- 权限查询（视图优先、ORM 回退）：`container_management/management/utils.py`
- 模型端跨字段一致性校验（`VesselVisit.clean()` 与 `save()`）：`container_management/management/models.py`
- 聚合搜索 ORM 查询（`select_related` + `Q`）：`container_management/management/views.py`
- 数据库建表脚本与视图定义：`sqlutil/createtable.sql`

（上述文件路径即可在仓库中定位到对应实现，建议答辩或审阅时结合代码进行逐条核对。）

---

## 结语

本章节在保持学术性与技术严谨性的前提下，归纳了系统的结构、核心模块实现、数据库访问与数据模型映射以及主要接口文档。文本引用了仓库中的若干关键文件路径以便核验实现细节。若需将此文件改写为英文版本、精简为答辩幻灯片要点，或拆分为多个子文件，请告知。
