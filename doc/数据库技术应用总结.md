# æ¸¯å£é›†è£…ç®±è¿è¥ç³»ç»Ÿ - æ•°æ®åº“æŠ€æœ¯åº”ç”¨æ€»ç»“

## ğŸ“‹ ç­”è¾©æŠ€æœ¯ç‚¹æ¸…å•

æœ¬æ–‡æ¡£è¯¦ç»†åˆ—å‡ºäº†ç³»ç»Ÿä¸­ä½¿ç”¨çš„æ‰€æœ‰æ•°æ®åº“æŠ€æœ¯ï¼Œä¾›ç­”è¾©æ—¶å‚è€ƒã€‚

---

## âœ… 1. è‡ªå®šä¹‰å®Œæ•´æ€§çº¦æŸæ¡ä»¶

### å®ç°ä½ç½®ï¼š`init_database.sql` / `createtable.sql`

#### 1.1 CHECK çº¦æŸ - æ•°æ®ç±»å‹é™åˆ¶

**ç¤ºä¾‹ 1ï¼šç›¸å…³æ–¹ç±»å‹çº¦æŸ**

```sql
CONSTRAINT `CHK_Party_Type` CHECK (`Party_Type` IN ('COMPANY', 'PERSON'))
```

- **ä½œç”¨**ï¼šé™åˆ¶ `Party_Type` å­—æ®µåªèƒ½è¾“å…¥ 'COMPANY'ï¼ˆå…¬å¸ï¼‰æˆ– 'PERSON'ï¼ˆä¸ªäººï¼‰
- **åº”ç”¨åœºæ™¯**ï¼šç¡®ä¿ç›¸å…³æ–¹ç±»å‹æ•°æ®çš„æ­£ç¡®æ€§

**ç¤ºä¾‹ 2ï¼šé›†è£…ç®±ç¼–å·æ ¼å¼çº¦æŸ**

```sql
CONSTRAINT `CHK_Container_Number_Format`
CHECK (`Container_Number` REGEXP '^[A-Z]{4}[0-9]{7}$')
```

- **ä½œç”¨**ï¼šéªŒè¯é›†è£…ç®±ç¼–å·å¿…é¡»ç¬¦åˆ ISO æ ‡å‡†æ ¼å¼ï¼ˆ4 ä¸ªå¤§å†™å­—æ¯+7 ä½æ•°å­—ï¼‰
- **åº”ç”¨åœºæ™¯**ï¼šé˜²æ­¢è¾“å…¥é”™è¯¯çš„ç®±å·æ ¼å¼

**ç¤ºä¾‹ 3ï¼šæ—¶é—´é€»è¾‘çº¦æŸ**

```sql
CONSTRAINT `CHK_Visit_Time_Logic`
CHECK (`ATD` >= `ATA` OR `ATD` IS NULL)
```

- **ä½œç”¨**ï¼šç¡®ä¿ç¦»æ¸¯æ—¶é—´ï¼ˆATDï¼‰å¿…é¡»æ™šäºæˆ–ç­‰äºåˆ°æ¸¯æ—¶é—´ï¼ˆATAï¼‰
- **åº”ç”¨åœºæ™¯**ï¼šä¿è¯èˆ¹èˆ¶è®¿é—®æ—¶é—´æ•°æ®çš„é€»è¾‘æ­£ç¡®æ€§

#### 1.2 å¤–é”®çº¦æŸ - å¼•ç”¨å®Œæ•´æ€§

**ç¤ºä¾‹ï¼šç”¨æˆ·å…³è”ç›¸å…³æ–¹**

```sql
CONSTRAINT `FK_User_links_to_Party`
FOREIGN KEY (`Party_ID`) REFERENCES `Party`(`Party_ID`)
```

- **ä½œç”¨**ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½å…³è”å·²å­˜åœ¨çš„ç›¸å…³æ–¹
- **çº§è”æ“ä½œ**ï¼šä½¿ç”¨ `ON DELETE SET NULL` ä¿è¯æ•°æ®ä¸€è‡´æ€§

---

## âœ… 2. åˆ©ç”¨é€šé…ç¬¦çš„æ¨¡ç³Šæœç´¢

### å®ç°ä½ç½®ï¼š`container_management/management/admin.py`

#### 2.1 Django Admin æœç´¢åŠŸèƒ½

Django Admin çš„ `search_fields` ä¼šè‡ªåŠ¨è½¬æ¢ä¸º SQL çš„ `LIKE` æŸ¥è¯¢ï¼š

**ç¤ºä¾‹ 1ï¼šç›¸å…³æ–¹æœç´¢**

```python
class PartyAdmin(admin.ModelAdmin):
    search_fields = ['party_name', 'contact_person', 'email']
```

- **SQL è½¬æ¢**ï¼š`WHERE party_name LIKE '%å…³é”®è¯%' OR contact_person LIKE '%å…³é”®è¯%'`
- **åŠŸèƒ½**ï¼šæ”¯æŒåœ¨ç›¸å…³æ–¹åç§°ã€è”ç³»äººã€é‚®ç®±ä¸­æ¨¡ç³Šæœç´¢

**ç¤ºä¾‹ 2ï¼šé›†è£…ç®±æœç´¢**

```python
class ContainerMasterAdmin(admin.ModelAdmin):
    search_fields = ['container_number']
```

- **åŠŸèƒ½**ï¼šæ”¯æŒæŒ‰ç®±å·æ¨¡ç³Šæœç´¢

**ç¤ºä¾‹ 3ï¼šèˆ¹èˆ¶æœç´¢**

```python
class VesselMasterAdmin(admin.ModelAdmin):
    search_fields = ['vessel_name', 'imo_number']
```

- **åŠŸèƒ½**ï¼šæ”¯æŒæŒ‰èˆ¹åæˆ– IMO ç¼–å·æœç´¢

#### 2.2 æ‰€æœ‰æ”¯æŒæ¨¡ç³Šæœç´¢çš„è¡¨

| è¡¨å            | æœç´¢å­—æ®µ                                | è¯´æ˜             |
| --------------- | --------------------------------------- | ---------------- |
| Party           | party_name, contact_person, email       | ç›¸å…³æ–¹ä¿¡æ¯æœç´¢   |
| PortMaster      | port_name, port_code                    | æ¸¯å£ä¿¡æ¯æœç´¢     |
| Users           | username, full_name, email              | ç”¨æˆ·ä¿¡æ¯æœç´¢     |
| ContainerMaster | container_number                        | é›†è£…ç®±ç¼–å·æœç´¢   |
| VesselMaster    | vessel_name, imo_number                 | èˆ¹èˆ¶ä¿¡æ¯æœç´¢     |
| VesselVisit     | voyage_number_in, voyage_number_out     | èˆªæ¬¡æœç´¢         |
| Booking         | booking_number                          | è®¢èˆ±å·æœç´¢       |
| Task            | container_master_id\_\_container_number | ä»»åŠ¡å…³è”ç®±å·æœç´¢ |

---

## âœ… 3. é€šè¿‡ç´¢å¼•æé«˜æŸ¥è¯¢é€Ÿåº¦

### å®ç°ä½ç½®ï¼š`init_database.sql` / `createtable.sql`

#### 3.1 ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

æ‰€æœ‰è¡¨éƒ½æœ‰ `AUTO_INCREMENT` ä¸»é”®ï¼Œè‡ªåŠ¨åˆ›å»ºèšç°‡ç´¢å¼•ï¼š

```sql
PRIMARY KEY (`Party_ID`)
```

#### 3.2 å”¯ä¸€ç´¢å¼•

**ç¤ºä¾‹ 1ï¼šç›¸å…³æ–¹åç§°å”¯ä¸€ç´¢å¼•**

```sql
UNIQUE INDEX `UQ_Party_Name` (`Party_Name`)
```

- **ä½œç”¨**ï¼šç¡®ä¿ç›¸å…³æ–¹åç§°ä¸é‡å¤ï¼ŒåŒæ—¶åŠ é€ŸæŒ‰åç§°æŸ¥è¯¢

**ç¤ºä¾‹ 2ï¼šé›†è£…ç®±ç¼–å·å”¯ä¸€ç´¢å¼•**

```sql
UNIQUE INDEX `UQ_Container_Number` (`Container_Number`)
```

- **ä½œç”¨**ï¼šç¡®ä¿ç®±å·å”¯ä¸€ï¼ŒåŠ é€Ÿç®±å·æŸ¥è¯¢

**ç¤ºä¾‹ 3ï¼šå¤åˆå”¯ä¸€ç´¢å¼•**

```sql
UNIQUE INDEX `UQ_Port_Berth_Name` (`Port_ID`, `Berth_Name`)
```

- **ä½œç”¨**ï¼šç¡®ä¿åŒä¸€æ¸¯å£ä¸‹æ³Šä½åç§°ä¸é‡å¤ï¼ŒåŠ é€Ÿæ¸¯å£-æ³Šä½è”åˆæŸ¥è¯¢

#### 3.3 å¤–é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

æ‰€æœ‰å¤–é”®çº¦æŸä¼šè‡ªåŠ¨åˆ›å»ºç´¢å¼•ï¼ŒåŠ é€Ÿ JOIN æ“ä½œï¼š

```sql
CONSTRAINT `FK_User_links_to_Party`
FOREIGN KEY (`Party_ID`) REFERENCES `Party`(`Party_ID`)
```

#### 3.4 ç´¢å¼•ç»Ÿè®¡

| ç´¢å¼•ç±»å‹     | æ•°é‡  | è¯´æ˜           |
| ------------ | ----- | -------------- |
| ä¸»é”®ç´¢å¼•     | 15 ä¸ª | æ¯ä¸ªè¡¨ 1 ä¸ª    |
| å”¯ä¸€ç´¢å¼•     | 12 ä¸ª | é˜²æ­¢é‡å¤æ•°æ®   |
| å¤åˆå”¯ä¸€ç´¢å¼• | 4 ä¸ª  | å¤šå­—æ®µç»„åˆå”¯ä¸€ |
| å¤–é”®ç´¢å¼•     | 20+ä¸ª | åŠ é€Ÿå…³è”æŸ¥è¯¢   |

---

## âš ï¸ 4. è§¦å‘å™¨çš„ä½¿ç”¨ï¼ˆéœ€è¦è¡¥å……ï¼‰

### å½“å‰çŠ¶æ€ï¼šâŒ æœªå®ç°

### å»ºè®®æ·»åŠ çš„è§¦å‘å™¨ç¤ºä¾‹ï¼š

#### 4.1 ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ›´æ–°é›†è£…ç®±çŠ¶æ€

```sql
DELIMITER $$

CREATE TRIGGER `TRG_Task_Complete_Update_Container`
AFTER UPDATE ON `Task`
FOR EACH ROW
BEGIN
    IF NEW.Status = 'Completed' AND OLD.Status != 'Completed' THEN
        -- å¦‚æœæ˜¯è£…èˆ¹ä»»åŠ¡ï¼Œæ›´æ–°é›†è£…ç®±çŠ¶æ€ä¸ºåœ¨èˆ¹ä¸Š
        IF NEW.Task_Type = 'Load' THEN
            UPDATE Container_Master
            SET Current_Status = 'OnVessel'
            WHERE Container_Master_ID = NEW.Container_Master_ID;
        -- å¦‚æœæ˜¯å¸èˆ¹ä»»åŠ¡ï¼Œæ›´æ–°é›†è£…ç®±çŠ¶æ€ä¸ºåœ¨å †åœº
        ELSEIF NEW.Task_Type = 'Discharge' THEN
            UPDATE Container_Master
            SET Current_Status = 'InYard'
            WHERE Container_Master_ID = NEW.Container_Master_ID;
        -- å¦‚æœæ˜¯å‡ºé—¸ä»»åŠ¡ï¼Œæ›´æ–°é›†è£…ç®±çŠ¶æ€ä¸ºå·²å‡ºé—¸
        ELSEIF NEW.Task_Type = 'GateOut' THEN
            UPDATE Container_Master
            SET Current_Status = 'GateOut'
            WHERE Container_Master_ID = NEW.Container_Master_ID;
        END IF;
    END IF;
END$$

DELIMITER ;
```

#### 4.2 ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ›´æ–°ç®±ä½çŠ¶æ€

```sql
DELIMITER $$

CREATE TRIGGER `TRG_Task_Complete_Update_Slot`
AFTER UPDATE ON `Task`
FOR EACH ROW
BEGIN
    IF NEW.Status = 'Completed' AND OLD.Status != 'Completed' THEN
        -- æ¸…ç©ºèµ·å§‹ç®±ä½çš„é›†è£…ç®±
        UPDATE Yard_Slot
        SET Current_Container_ID = NULL,
            Slot_Status = 'Available'
        WHERE Slot_ID = NEW.From_Slot_ID;

        -- æ›´æ–°ç›®æ ‡ç®±ä½çš„é›†è£…ç®±
        UPDATE Yard_Slot
        SET Current_Container_ID = NEW.Container_Master_ID,
            Slot_Status = 'Occupied'
        WHERE Slot_ID = NEW.To_Slot_ID;
    END IF;
END$$

DELIMITER ;
```

#### 4.3 é›†è£…ç®±æ’å…¥æ—¶è‡ªåŠ¨éªŒè¯æ ¼å¼

```sql
DELIMITER $$

CREATE TRIGGER `TRG_Container_Validate_Format`
BEFORE INSERT ON `Container_Master`
FOR EACH ROW
BEGIN
    IF NEW.Container_Number NOT REGEXP '^[A-Z]{4}[0-9]{7}$' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'é›†è£…ç®±ç¼–å·æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»ä¸º4ä¸ªå¤§å†™å­—æ¯+7ä½æ•°å­—';
    END IF;
END$$

DELIMITER ;
```

---

## âœ… 5. å¤–è¿æ¥ã€ç»Ÿè®¡æŸ¥è¯¢ç­‰å¤æ‚æŸ¥è¯¢è¯­å¥

### å®ç°ä½ç½®ï¼š`container_management/management/admin.py`

#### 5.1 å·¦å¤–è¿æ¥ï¼ˆLEFT JOINï¼‰

**ç¤ºä¾‹ï¼šå †åœºåº“å­˜æŸ¥è¯¢**

```sql
SELECT
    yb.Block_Name AS å †åœºåŒº,
    cm.Container_Number AS ç®±å·,
    p.Party_Name AS ç®±ä¸»
FROM Yard_Slot slot
JOIN Container_Master cm ON slot.Current_Container_ID = cm.Container_Master_ID
LEFT JOIN Party p ON cm.Owner_Party_ID = p.Party_ID
WHERE slot.Current_Container_ID IS NOT NULL
```

- **LEFT JOIN ä½œç”¨**ï¼šå³ä½¿é›†è£…ç®±æ²¡æœ‰å…³è”ç®±ä¸»ï¼Œä¹Ÿèƒ½æŸ¥è¯¢å‡ºé›†è£…ç®±ä¿¡æ¯
- **åº”ç”¨åœºæ™¯**ï¼šå †åœºåº“å­˜å®æ—¶æŸ¥è¯¢

#### 5.2 å¤šè¡¨å†…è¿æ¥ï¼ˆINNER JOINï¼‰

**ç¤ºä¾‹ï¼šä»»åŠ¡ç®¡ç†æŸ¥è¯¢**

```sql
SELECT
    t.Task_ID,
    cm.Container_Number AS ç®±å·,
    yb_from.Block_Name AS èµ·å§‹å †åœºåŒº,
    yb_to.Block_Name AS ç›®æ ‡å †åœºåŒº,
    vm.Vessel_Name AS èˆ¹èˆ¶
FROM Task t
JOIN Container_Master cm ON t.Container_Master_ID = cm.Container_Master_ID
JOIN Yard_Slot slot_from ON t.From_Slot_ID = slot_from.Slot_ID
JOIN Yard_Stack ys_from ON slot_from.Stack_ID = ys_from.Stack_ID
JOIN Yard_Block yb_from ON ys_from.Block_ID = yb_from.Block_ID
JOIN Yard_Slot slot_to ON t.To_Slot_ID = slot_to.Slot_ID
JOIN Yard_Stack ys_to ON slot_to.Stack_ID = ys_to.Stack_ID
JOIN Yard_Block yb_to ON ys_to.Block_ID = yb_to.Block_ID
LEFT JOIN Vessel_Visit vv ON t.Vessel_Visit_ID = vv.Vessel_Visit_ID
LEFT JOIN Vessel_Master vm ON vv.Vessel_ID = vm.Vessel_ID
```

- **å¤šè¡¨ JOIN**ï¼šè¿æ¥äº† 8 ä¸ªè¡¨ï¼Œè·å–å®Œæ•´çš„ä»»åŠ¡ä¿¡æ¯
- **åº”ç”¨åœºæ™¯**ï¼šä»»åŠ¡ç®¡ç†é¡µé¢

#### 5.3 ç»Ÿè®¡æŸ¥è¯¢ï¼ˆGROUP BY + èšåˆå‡½æ•°ï¼‰

**ç¤ºä¾‹ 1ï¼šé›†è£…ç®±çŠ¶æ€ç»Ÿè®¡**

```sql
SELECT
    Current_Status AS çŠ¶æ€,
    COUNT(*) AS æ•°é‡
FROM Container_Master
WHERE Current_Status IS NOT NULL
GROUP BY Current_Status
```

**ç¤ºä¾‹ 2ï¼šæŒ‰ç®±å‹ç»Ÿè®¡**

```sql
SELECT
    ct.Type_Code AS ç®±å‹,
    ct.Nominal_Size AS å°ºå¯¸,
    COUNT(*) AS æ•°é‡
FROM Container_Master cm
JOIN Container_Type_Dict ct ON cm.Type_Code = ct.Type_Code
GROUP BY ct.Type_Code, ct.Nominal_Size
ORDER BY æ•°é‡ DESC
```

**ç¤ºä¾‹ 3ï¼šå †åœºåˆ©ç”¨ç‡è®¡ç®—**

```sql
SELECT
    COUNT(*) AS æ€»ç®±ä½æ•°,
    SUM(CASE WHEN Current_Container_ID IS NOT NULL THEN 1 ELSE 0 END) AS å·²å ç”¨,
    ROUND(SUM(CASE WHEN Current_Container_ID IS NOT NULL THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS åˆ©ç”¨ç‡
FROM Yard_Slot
```

- **CASE è¡¨è¾¾å¼**ï¼šæ¡ä»¶ç»Ÿè®¡
- **èšåˆå‡½æ•°**ï¼šCOUNTã€SUMã€ROUND

**ç¤ºä¾‹ 4ï¼šèˆ¹èˆ¶è®¿é—®ç»Ÿè®¡**

```sql
SELECT
    vv.Vessel_Visit_ID,
    vm.Vessel_Name AS èˆ¹å,
    COUNT(DISTINCT t.Task_ID) AS ä»»åŠ¡æ•°,
    COUNT(DISTINCT t.Container_Master_ID) AS é›†è£…ç®±æ•°
FROM Vessel_Visit vv
JOIN Vessel_Master vm ON vv.Vessel_ID = vm.Vessel_ID
LEFT JOIN Task t ON vv.Vessel_Visit_ID = t.Vessel_Visit_ID
GROUP BY vv.Vessel_Visit_ID
```

- **DISTINCT**ï¼šå»é‡ç»Ÿè®¡
- **GROUP BY**ï¼šåˆ†ç»„ç»Ÿè®¡

#### 5.4 å­æŸ¥è¯¢

**ç¤ºä¾‹ï¼šæŒ‰å †åœºåŒºç»Ÿè®¡ç®±æ•°**

```sql
SELECT
    yb.Block_Name AS å †åœºåŒº,
    COUNT(*) AS ç®±æ•°
FROM Yard_Slot slot
JOIN Container_Master cm ON slot.Current_Container_ID = cm.Container_Master_ID
JOIN Yard_Stack ys ON slot.Stack_ID = ys.Stack_ID
JOIN Yard_Block yb ON ys.Block_ID = yb.Block_ID
WHERE slot.Current_Container_ID IS NOT NULL
GROUP BY yb.Block_Name
ORDER BY ç®±æ•° DESC
```

---

## âœ… 6. ä¿è¯å®‰å…¨æ€§çš„è§†å›¾ã€ç”¨æˆ·æƒé™ç­‰è¿ç”¨

### 6.1 è§†å›¾ï¼ˆVIEWï¼‰

#### å®ç°ä½ç½®ï¼š`init_database.sql` / `views.sql`

ç³»ç»Ÿå…±åˆ›å»ºäº† **12 ä¸ªè§†å›¾**ï¼Œè¦†ç›–å¤šä¸ªä¸šåŠ¡åœºæ™¯ï¼š

#### è§†å›¾åˆ—è¡¨

| è§†å›¾åç§°                           | åŠŸèƒ½è¯´æ˜       | ä¸»è¦ç”¨é€”                                           |
| ---------------------------------- | -------------- | -------------------------------------------------- |
| `View_Yard_Inventory_Live`         | å †åœºå®æ—¶åº“å­˜   | æŸ¥çœ‹å½“å‰å †åœºä¸­æ‰€æœ‰é›†è£…ç®±çš„ä½ç½®å’ŒçŠ¶æ€               |
| `View_Task_Details`                | ä»»åŠ¡è¯¦æƒ…       | æ˜¾ç¤ºä»»åŠ¡çš„å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬é›†è£…ç®±ã€ä½ç½®ã€ç”¨æˆ·ã€èˆ¹èˆ¶ç­‰ |
| `View_Vessel_Visit_Details`        | èˆ¹èˆ¶è®¿é—®è¯¦æƒ…   | æ˜¾ç¤ºèˆ¹èˆ¶è®¿é—®çš„å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç»Ÿè®¡ä¿¡æ¯               |
| `View_Booking_Details`             | è®¢èˆ±å•è¯¦æƒ…     | æ˜¾ç¤ºè®¢èˆ±å•çš„å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›¸å…³æ–¹ã€èˆªæ¬¡ç­‰           |
| `View_Yard_Utilization`            | å †åœºåˆ©ç”¨ç‡ç»Ÿè®¡ | æŒ‰å †åœºåŒºç»Ÿè®¡ç®±ä½åˆ©ç”¨æƒ…å†µ                           |
| `View_Container_Status_Summary`    | é›†è£…ç®±çŠ¶æ€ç»Ÿè®¡ | æŒ‰çŠ¶æ€ã€ç®±å‹ç»Ÿè®¡é›†è£…ç®±æ•°é‡                         |
| `View_User_Permissions`            | ç”¨æˆ·æƒé™       | æ˜¾ç¤ºç”¨æˆ·åŠå…¶æ‹¥æœ‰çš„æƒé™                             |
| `View_Task_Execution_Stats`        | ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡   | æŒ‰ç”¨æˆ·ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œæƒ…å†µ                             |
| `View_Container_Location_Tracking` | é›†è£…ç®±ä½ç½®è¿½è¸ª | æ˜¾ç¤ºæ‰€æœ‰é›†è£…ç®±çš„å½“å‰ä½ç½®å’ŒçŠ¶æ€                     |
| `View_Vessel_Visit_Statistics`     | èˆ¹èˆ¶è®¿é—®ç»Ÿè®¡   | æŒ‰èˆ¹èˆ¶ç»Ÿè®¡è®¿é—®æ¬¡æ•°å’Œé›†è£…ç®±æ•°é‡                     |
| `View_Yard_Available_Slots`        | å †åœºç©ºä½       | æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„å †åœºç©ºä½                             |
| `View_Pending_Tasks`               | å¾…æ‰§è¡Œä»»åŠ¡     | æ˜¾ç¤ºæ‰€æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡                               |

#### è§†å›¾ç¤ºä¾‹

**ç¤ºä¾‹ 1ï¼šå †åœºå®æ—¶åº“å­˜è§†å›¾**

```sql
CREATE OR REPLACE VIEW `View_Yard_Inventory_Live` AS
SELECT
    yb.Block_Name AS å †åœºåŒº,
    ys.Bay_Number AS è´ä½,
    ys.Row_Number AS æ’å·,
    slot.Tier_Number AS å±‚å·,
    slot.Slot_Coordinates AS åæ ‡ä»£ç ,
    cm.Container_Number AS ç®±å·,
    cm.Current_Status AS ç®±çŠ¶æ€,
    ct.Type_Code AS ISOä»£ç ,
    ct.Nominal_Size AS å°ºå¯¸_è‹±å°º,
    ct.Group_Code AS ç®±å‹ç»„,
    p.Party_Name AS ç®±ä¸»,
    p.SCAC_Code AS ç®±ä¸»ä»£ç 
FROM `Yard_Slot` slot
JOIN `Container_Master` cm ON slot.Current_Container_ID = cm.Container_Master_ID
JOIN `Container_Type_Dict` ct ON cm.Type_Code = ct.Type_Code
JOIN `Yard_Stack` ys ON slot.Stack_ID = ys.Stack_ID
JOIN `Yard_Block` yb ON ys.Block_ID = yb.Block_ID
LEFT JOIN `Party` p ON cm.Owner_Party_ID = p.Party_ID
WHERE slot.Current_Container_ID IS NOT NULL;
```

**ç¤ºä¾‹ 2ï¼šä»»åŠ¡è¯¦æƒ…è§†å›¾ï¼ˆå¤šè¡¨è¿æ¥ï¼‰**

```sql
CREATE OR REPLACE VIEW `View_Task_Details` AS
SELECT
    t.Task_ID AS ä»»åŠ¡ç¼–å·,
    t.Task_Type AS ä»»åŠ¡ç±»å‹,
    cm.Container_Number AS ç®±å·,
    yb_from.Block_Name AS èµ·å§‹å †åœºåŒº,
    yb_to.Block_Name AS ç›®æ ‡å †åœºåŒº,
    vm.Vessel_Name AS èˆ¹èˆ¶åç§°,
    u_creator.Username AS åˆ›å»ºäºº,
    u_executor.Username AS æ‰§è¡Œäºº
FROM `Task` t
JOIN `Container_Master` cm ON t.Container_Master_ID = cm.Container_Master_ID
JOIN `Yard_Slot` slot_from ON t.From_Slot_ID = slot_from.Slot_ID
JOIN `Yard_Stack` ys_from ON slot_from.Stack_ID = ys_from.Stack_ID
JOIN `Yard_Block` yb_from ON ys_from.Block_ID = yb_from.Block_ID
-- ... æ›´å¤šè¿æ¥
```

**ç¤ºä¾‹ 3ï¼šå †åœºåˆ©ç”¨ç‡ç»Ÿè®¡è§†å›¾ï¼ˆèšåˆæŸ¥è¯¢ï¼‰**

```sql
CREATE OR REPLACE VIEW `View_Yard_Utilization` AS
SELECT
    yb.Block_Name AS å †åœºåŒºåç§°,
    COUNT(DISTINCT slot.Slot_ID) AS ç®±ä½æ€»æ•°,
    COUNT(DISTINCT CASE WHEN slot.Current_Container_ID IS NOT NULL THEN slot.Slot_ID END) AS å·²å ç”¨ç®±ä½æ•°,
    ROUND(
        COUNT(DISTINCT CASE WHEN slot.Current_Container_ID IS NOT NULL THEN slot.Slot_ID END) * 100.0 /
        NULLIF(COUNT(DISTINCT slot.Slot_ID), 0),
        2
    ) AS åˆ©ç”¨ç‡_ç™¾åˆ†æ¯”
FROM `Yard_Block` yb
LEFT JOIN `Yard_Stack` ys ON yb.Block_ID = ys.Block_ID
LEFT JOIN `Yard_Slot` slot ON ys.Stack_ID = slot.Stack_ID
GROUP BY yb.Block_ID, yb.Block_Name;
```

**è§†å›¾çš„ä½œç”¨ï¼š**

- âœ… **æ•°æ®å®‰å…¨**ï¼šéšè—åº•å±‚è¡¨ç»“æ„ï¼Œåªæš´éœ²å¿…è¦å­—æ®µ
- âœ… **ç®€åŒ–æŸ¥è¯¢**ï¼šå¤æ‚å¤šè¡¨æŸ¥è¯¢å°è£…ä¸ºç®€å•è§†å›¾
- âœ… **æƒé™æ§åˆ¶**ï¼šå¯ä»¥åªæˆäºˆè§†å›¾æƒé™ï¼Œä¸æˆäºˆè¡¨æƒé™
- âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šç»Ÿä¸€çš„æ•°æ®å±•ç¤ºé€»è¾‘
- âœ… **ä¸šåŠ¡å°è£…**ï¼šå°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å°è£…åœ¨è§†å›¾ä¸­
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šè§†å›¾å¯ä»¥ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ

### 6.2 ç”¨æˆ·æƒé™ç®¡ç†

#### å®ç°ä½ç½®ï¼š`init_database.sql` / `createtable.sql`

**æƒé™è¡¨ç»“æ„ï¼š**

```sql
CREATE TABLE `Permissions` (
    `Permission_ID` INT NOT NULL AUTO_INCREMENT,
    `Permission_Name` VARCHAR(100) NOT NULL,
    `Description` VARCHAR(255) NULL,
    PRIMARY KEY (`Permission_ID`),
    UNIQUE INDEX `UQ_Permission_Name` (`Permission_Name`)
) COMMENT='æƒé™';
```

**ç”¨æˆ·æƒé™å…³è”è¡¨ï¼š**

```sql
CREATE TABLE `User_Permissions` (
    `User_ID` INT NOT NULL,
    `Permission_ID` INT NOT NULL,
    PRIMARY KEY (`User_ID`, `Permission_ID`),
    CONSTRAINT `FK_UserPerm_maps_User`
        FOREIGN KEY (`User_ID`) REFERENCES `Users`(`User_ID`),
    CONSTRAINT `FK_UserPerm_maps_Permission`
        FOREIGN KEY (`Permission_ID`) REFERENCES `Permissions`(`Permission_ID`)
) COMMENT='ç”¨æˆ·æƒé™';
```

**æƒé™ç®¡ç†ç‰¹ç‚¹ï¼š**

- âœ… **å¤šå¯¹å¤šå…³ç³»**ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæƒé™ï¼Œä¸€ä¸ªæƒé™å¯ä»¥æˆäºˆå¤šä¸ªç”¨æˆ·
- âœ… **ç»†ç²’åº¦æ§åˆ¶**ï¼šå¯ä»¥å®šä¹‰å…·ä½“çš„æ“ä½œæƒé™ï¼ˆå¦‚ï¼šæŸ¥çœ‹åº“å­˜ã€åˆ›å»ºä»»åŠ¡ã€ä¿®æ”¹è®¢èˆ±å•ç­‰ï¼‰
- âœ… **å¤–é”®çº¦æŸ**ï¼šç¡®ä¿æƒé™æ•°æ®çš„ä¸€è‡´æ€§

**å»ºè®®çš„æƒé™ç¤ºä¾‹ï¼š**

```sql
INSERT INTO Permissions (Permission_Name, Description) VALUES
('VIEW_INVENTORY', 'æŸ¥çœ‹å †åœºåº“å­˜'),
('CREATE_TASK', 'åˆ›å»ºä½œä¸šä»»åŠ¡'),
('UPDATE_TASK', 'æ›´æ–°ä»»åŠ¡çŠ¶æ€'),
('VIEW_VESSEL', 'æŸ¥çœ‹èˆ¹èˆ¶ä¿¡æ¯'),
('MANAGE_BOOKING', 'ç®¡ç†è®¢èˆ±å•'),
('VIEW_STATISTICS', 'æŸ¥çœ‹ç»Ÿè®¡æŠ¥è¡¨');
```

---

## âœ… 7. åŸºæœ¬è¡¨ä¹‹é—´çš„è”åŠ¨ï¼ˆå¤–é”®çº§è”æ“ä½œï¼‰

### å®ç°ä½ç½®ï¼š`init_database.sql` / `createtable.sql`

#### 7.1 å¤–é”®çº¦æŸå®ç°è¡¨é—´è”åŠ¨

**ç¤ºä¾‹ 1ï¼šçº§è”åˆ é™¤ï¼ˆCASCADEï¼‰**

```sql
CONSTRAINT `FK_Stack_in_Block`
FOREIGN KEY (`Block_ID`) REFERENCES `Yard_Block`(`Block_ID`)
ON DELETE CASCADE
```

- **ä½œç”¨**ï¼šåˆ é™¤å †åœºåŒºæ—¶ï¼Œè‡ªåŠ¨åˆ é™¤è¯¥åŒºä¸‹çš„æ‰€æœ‰å †æ ˆ
- **åº”ç”¨åœºæ™¯**ï¼š`Yard_Stack` è¡¨ä¾èµ– `Yard_Block` è¡¨

**ç¤ºä¾‹ 2ï¼šçº§è”è®¾ç½®ä¸º NULLï¼ˆSET NULLï¼‰**

```sql
CONSTRAINT `FK_User_links_to_Party`
FOREIGN KEY (`Party_ID`) REFERENCES `Party`(`Party_ID`)
ON DELETE SET NULL
```

- **ä½œç”¨**ï¼šåˆ é™¤ç›¸å…³æ–¹æ—¶ï¼Œç”¨æˆ·è¡¨çš„ `Party_ID` è‡ªåŠ¨è®¾ç½®ä¸º NULL
- **åº”ç”¨åœºæ™¯**ï¼šä¿ç•™ç”¨æˆ·è®°å½•ï¼Œä½†è§£é™¤å…³è”å…³ç³»

**ç¤ºä¾‹ 3ï¼šçº§è”ä¿æŠ¤ï¼ˆPROTECTï¼‰**

```sql
CONSTRAINT `FK_Container_ref_Type`
FOREIGN KEY (`Type_Code`) REFERENCES `Container_Type_Dict`(`Type_Code`)
ON DELETE PROTECT
```

- **ä½œç”¨**ï¼šå¦‚æœå­˜åœ¨ä½¿ç”¨è¯¥ç±»å‹çš„é›†è£…ç®±ï¼Œåˆ™ä¸å…è®¸åˆ é™¤ç±»å‹å­—å…¸
- **åº”ç”¨åœºæ™¯**ï¼šä¿æŠ¤åŸºç¡€æ•°æ®ä¸è¢«è¯¯åˆ 

#### 7.2 è¡¨é—´è”åŠ¨å…³ç³»å›¾

```
Party (ç›¸å…³æ–¹)
  â”œâ”€â†’ Users (ç”¨æˆ·) [SET NULL]
  â”œâ”€â†’ Vessel_Master (èˆ¹èˆ¶) [SET NULL]
  â””â”€â†’ Container_Master (é›†è£…ç®±) [SET NULL]

Port_Master (æ¸¯å£)
  â””â”€â†’ Berth (æ³Šä½) [CASCADE]

Yard_Block (å †åœºåŒº)
  â””â”€â†’ Yard_Stack (å †æ ˆ) [CASCADE]
        â””â”€â†’ Yard_Slot (ç®±ä½) [CASCADE]

Container_Type_Dict (ç±»å‹å­—å…¸)
  â””â”€â†’ Container_Master (é›†è£…ç®±) [PROTECT]

Vessel_Master (èˆ¹èˆ¶)
  â””â”€â†’ Vessel_Visit (èˆ¹èˆ¶è®¿é—®) [CASCADE]

Vessel_Visit (èˆ¹èˆ¶è®¿é—®)
  â”œâ”€â†’ Booking (è®¢èˆ±å•) [SET NULL]
  â””â”€â†’ Task (ä»»åŠ¡) [SET NULL]

Container_Master (é›†è£…ç®±)
  â””â”€â†’ Yard_Slot (ç®±ä½) [SET NULL]
  â””â”€â†’ Task (ä»»åŠ¡) [CASCADE]

Users (ç”¨æˆ·)
  â”œâ”€â†’ Task (ä»»åŠ¡) [CASCADE] - åˆ›å»ºäºº
  â”œâ”€â†’ Task (ä»»åŠ¡) [SET NULL] - æ‰§è¡Œäºº
  â””â”€â†’ User_Permissions (ç”¨æˆ·æƒé™) [CASCADE]
```

#### 7.3 è”åŠ¨æ“ä½œç¤ºä¾‹

**åœºæ™¯ 1ï¼šåˆ é™¤å †åœºåŒº**

```sql
DELETE FROM Yard_Block WHERE Block_ID = 1;
```

- **è‡ªåŠ¨æ‰§è¡Œ**ï¼š
  1. åˆ é™¤è¯¥åŒºä¸‹çš„æ‰€æœ‰ `Yard_Stack` è®°å½•
  2. åˆ é™¤è¿™äº›å †æ ˆä¸‹çš„æ‰€æœ‰ `Yard_Slot` è®°å½•
  3. å°†ä½¿ç”¨è¿™äº›ç®±ä½çš„ `Task` è®°å½•çš„ç›¸å…³å­—æ®µè®¾ç½®ä¸º NULL

**åœºæ™¯ 2ï¼šåˆ é™¤ç›¸å…³æ–¹**

```sql
DELETE FROM Party WHERE Party_ID = 1;
```

- **è‡ªåŠ¨æ‰§è¡Œ**ï¼š
  1. `Users` è¡¨çš„ `Party_ID` è®¾ç½®ä¸º NULL
  2. `Vessel_Master` è¡¨çš„ `Carrier_Party_ID` è®¾ç½®ä¸º NULL
  3. `Container_Master` è¡¨çš„ `Owner_Party_ID` è®¾ç½®ä¸º NULL

**åœºæ™¯ 3ï¼šåˆ é™¤é›†è£…ç®±ç±»å‹**

```sql
DELETE FROM Container_Type_Dict WHERE Type_Code = '22G1';
```

- **ç»“æœ**ï¼šå¦‚æœå­˜åœ¨ä½¿ç”¨è¯¥ç±»å‹çš„é›†è£…ç®±ï¼Œåˆ é™¤æ“ä½œä¼šè¢«æ‹’ç»ï¼ˆPROTECTï¼‰

---

## ğŸ“Š æŠ€æœ¯åº”ç”¨ç»Ÿè®¡

| æŠ€æœ¯ç‚¹              | å®ç°çŠ¶æ€  | æ•°é‡/ç¤ºä¾‹           |
| ------------------- | --------- | ------------------- |
| âœ… è‡ªå®šä¹‰å®Œæ•´æ€§çº¦æŸ | âœ… å·²å®ç° | 3 ä¸ª CHECK çº¦æŸ     |
| âœ… é€šé…ç¬¦æ¨¡ç³Šæœç´¢   | âœ… å·²å®ç° | 8 ä¸ªè¡¨çš„æœç´¢åŠŸèƒ½    |
| âœ… ç´¢å¼•ä¼˜åŒ–         | âœ… å·²å®ç° | 50+ä¸ªç´¢å¼•           |
| âš ï¸ è§¦å‘å™¨           | âš ï¸ éœ€è¡¥å…… | å»ºè®®æ·»åŠ  6 ä¸ªè§¦å‘å™¨ |
| âœ… å¤–è¿æ¥æŸ¥è¯¢       | âœ… å·²å®ç° | å¤šå¤„ LEFT JOIN      |
| âœ… ç»Ÿè®¡æŸ¥è¯¢         | âœ… å·²å®ç° | GROUP BY + èšåˆå‡½æ•° |
| âœ… è§†å›¾             | âœ… å·²å®ç° | 12 ä¸ªè§†å›¾           |
| âœ… ç”¨æˆ·æƒé™         | âœ… å·²å®ç° | æƒé™è¡¨+å…³è”è¡¨       |
| âœ… è¡¨é—´è”åŠ¨         | âœ… å·²å®ç° | 20+ä¸ªå¤–é”®çº¦æŸ       |

---

## ğŸ¯ ç­”è¾©å»ºè®®

### 1. é‡ç‚¹å¼ºè°ƒçš„æŠ€æœ¯ç‚¹

1. **å®Œæ•´æ€§çº¦æŸ**ï¼šå±•ç¤º CHECK çº¦æŸå¦‚ä½•ä¿è¯æ•°æ®æ­£ç¡®æ€§
2. **å¤æ‚æŸ¥è¯¢**ï¼šå±•ç¤ºå¤šè¡¨ JOIN å’Œç»Ÿè®¡æŸ¥è¯¢çš„å®é™…åº”ç”¨
3. **è§†å›¾å’Œæƒé™**ï¼šè¯´æ˜å¦‚ä½•é€šè¿‡è§†å›¾å’Œæƒé™è¡¨ä¿è¯æ•°æ®å®‰å…¨
4. **è¡¨é—´è”åŠ¨**ï¼šæ¼”ç¤ºå¤–é”®çº¦æŸçš„çº§è”æ“ä½œæ•ˆæœ

### 2. éœ€è¦è¡¥å……çš„å†…å®¹

- **è§¦å‘å™¨**ï¼šå»ºè®®æ·»åŠ ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ›´æ–°é›†è£…ç®±çŠ¶æ€çš„è§¦å‘å™¨
- **å­˜å‚¨è¿‡ç¨‹**ï¼šå¯ä»¥æ·»åŠ ä¸€äº›å¸¸ç”¨çš„ä¸šåŠ¡é€»è¾‘å­˜å‚¨è¿‡ç¨‹

### 3. æ¼”ç¤ºå»ºè®®

1. å±•ç¤º CHECK çº¦æŸï¼šå°è¯•æ’å…¥ä¸ç¬¦åˆæ ¼å¼çš„æ•°æ®ï¼Œå±•ç¤ºé”™è¯¯æç¤º
2. å±•ç¤ºæ¨¡ç³Šæœç´¢ï¼šåœ¨ Admin ç•Œé¢æ¼”ç¤ºæœç´¢åŠŸèƒ½
3. å±•ç¤ºç»Ÿè®¡æŸ¥è¯¢ï¼šæ‰“å¼€ç»Ÿè®¡æŠ¥è¡¨é¡µé¢ï¼Œå±•ç¤º GROUP BY æŸ¥è¯¢ç»“æœ
4. å±•ç¤ºè¡¨é—´è”åŠ¨ï¼šåˆ é™¤ä¸€ä¸ªå †åœºåŒºï¼Œå±•ç¤ºçº§è”åˆ é™¤æ•ˆæœ

---

## ğŸ“ æ€»ç»“

æœ¬ç³»ç»Ÿå…¨é¢åº”ç”¨äº†æ•°æ®åº“è¯¾ç¨‹çš„æ ¸å¿ƒæŠ€æœ¯ï¼š

- âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šé€šè¿‡çº¦æŸæ¡ä»¶ä¿è¯æ•°æ®æ­£ç¡®æ€§
- âœ… **æŸ¥è¯¢ä¼˜åŒ–**ï¼šé€šè¿‡ç´¢å¼•å’Œå¤æ‚æŸ¥è¯¢æé«˜æ€§èƒ½
- âœ… **æ•°æ®å®‰å…¨**ï¼šé€šè¿‡è§†å›¾å’Œæƒé™ç®¡ç†ä¿è¯å®‰å…¨æ€§
- âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šé€šè¿‡å¤–é”®çº¦æŸä¿è¯è¡¨é—´æ•°æ®è”åŠ¨

ç³»ç»Ÿè®¾è®¡ç¬¦åˆæ•°æ®åº“è®¾è®¡çš„æœ€ä½³å®è·µï¼Œé€‚åˆä½œä¸ºè¯¾ç¨‹è®¾è®¡é¡¹ç›®å±•ç¤ºã€‚
